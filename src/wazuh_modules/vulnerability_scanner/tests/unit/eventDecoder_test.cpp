/*
 * Wazuh Vulnerability Scanner - Unit Tests
 * Copyright (C) 2015, Wazuh Inc.
 * September 21, 2023.
 *
 * This program is free software; you can redistribute it
 * and/or modify it under the terms of the GNU General Public
 * License (version 2) as published by the FSF - Free Software
 * Foundation.
 */

#include "eventDecoder_test.hpp"
#include "cve5_generated.h"
#include "databaseFeedManager/eventContext.hpp"
#include "databaseFeedManager/eventDecoder.hpp"
#include "flatbuffers/flatbuffers.h"
#include "flatbuffers/idl.h"
#include "json.hpp"
#include "rocksDBWrapper.hpp"
#include <memory>
#include <string>
#include <vector>

const std::string CVE_ID {"CVE-2010-0002"};

auto constexpr CREATED_RESOURCE {R"(
    {
        "offset": 1,
        "type": "create",
        "version": 1,
        "context": "vulnerabilities",
        "resource": "CVE-2010-0002",
        "payload":
        {
            "containers": {
                "adp": [
                    {
                        "affected": [
                            {
                                "defaultStatus": "unaffected",
                                "platforms": [
                                    "bookworm"
                                ],
                                "product": "bash",
                                "vendor": "debian"
                            },
                            {
                                "defaultStatus": "affected",
                                "platforms": [
                                    "bookworm"
                                ],
                                "product": "bash",
                                "vendor": "debian"
                            }
                        ],
                        "descriptions": [
                            {
                                "lang": "en",
                                "value": "The /etc/profile.d/60alias.sh script in the Mandriva bash package for Bash 2.05b, 3.0, 3.2, 3.2.48, and 4.0 enables the --show-control-chars option in LS_OPTIONS, which allows local users to send escape sequences to terminal emulators, or hide the existence of a file, via a crafted filename."
                            }
                        ],
                        "providerMetadata": {
                            "orgId": "79363d38-fa19-49d1-9214-5f28da3f3ac5"
                        },
                        "references": [
                            {
                                "url": "https://security-tracker.debian.org/tracker/CVE-2010-0002"
                            }
                        ]
                    }
                ],
                "cna": {
                    "affected": [
                        {
                            "cpes": [
                                "cpe:2.3:a:gnu:bash:2.05:b:*:*:*:*:*:*"
                            ],
                            "defaultStatus": "unaffected",
                            "product": "bash b",
                            "vendor": "gnu",
                            "versions": [
                                {
                                    "status": "affected",
                                    "version": "2.05"
                                }
                            ]
                        }
                    ],
                    "descriptions": [
                        {
                            "lang": "en",
                            "value": "The /etc/profile.d/60alias.sh script in the Mandriva bash package for Bash 2.05b, 3.0, 3.2, 3.2.48, and 4.0 enables the --show-control-chars option in LS_OPTIONS, which allows local users to send escape sequences to terminal emulators, or hide the existence of a file, via a crafted filename."
                        }
                    ],
                    "metrics": [
                        {
                            "cvssV2_0": {
                                "accessComplexity": "LOW",
                                "accessVector": "LOCAL",
                                "authentication": "NONE",
                                "availabilityImpact": "PARTIAL",
                                "baseScore": 2.1,
                                "confidentialityImpact": "NONE",
                                "integrityImpact": "NONE",
                                "vectorString": "AV:L/AC:L/Au:N/C:N/I:N/A:P",
                                "version": "2.0"
                            },
                            "format": "CVSS"
                        }
                    ],
                    "problemTypes": [
                        {
                            "descriptions": [
                                {
                                    "description": "CWE-20",
                                    "lang": "en"
                                }
                            ]
                        }
                    ],
                    "providerMetadata": {
                        "orgId": "00000000-0000-4000-A000-000000000000",
                        "shortName": "@redhat.com"
                    },
                    "references": [
                        {
                            "name": "https://qa.mandriva.com/show_bug.cgi?id=56882",
                            "url": "https://qa.mandriva.com/show_bug.cgi?id=56882"
                        }
                    ]
                }
            },
            "cveMetadata": {
                "assignerOrgId": "00000000-0000-4000-A000-000000000000",
                "assignerShortName": "@redhat.com",
                "cveId": "CVE-2010-0002",
                "datePublished": "2010-01-14T18:30:00.000Z",
                "dateUpdated": "2011-08-08T04:00:00.000Z",
                "state": "PUBLISHED"
            },
            "dataType": "CVE_RECORD",
            "dataVersion": "5.0"
        }
    }
)"};

auto constexpr UPDATED_RESOURCE {R"(
    {
        "offset": 2,
        "type": "update",
        "version": 1,
        "context": "vulnerabilities",
        "resource": "CVE-2010-0002",
        "operations":
            [
                {
                    "op": "replace",
                    "path": "/containers/adp/0/affected/0/defaultStatus",
                    "value": "unknown"
                },
                {
                    "op": "add",
                    "path": "/containers/adp/0/affected/1/platforms/-",
                    "value": "buster"
                },
                {
                    "op": "remove",
                    "path": "/containers/cna/problemTypes"
                }
            ]
    }
)"};

auto constexpr UPDATED_DATA {R"(
    {
        "containers": {
            "adp": [
                {
                    "affected": [
                        {
                            "defaultStatus": "unknown",
                            "platforms": [
                                "bookworm"
                            ],
                            "product": "bash",
                            "vendor": "debian"
                        },
                        {
                            "defaultStatus": "affected",
                            "platforms": [
                                "bookworm",
                                "buster"
                            ],
                            "product": "bash",
                            "vendor": "debian"
                        }
                    ],
                    "descriptions": [
                        {
                            "lang": "en",
                            "value": "The /etc/profile.d/60alias.sh script in the Mandriva bash package for Bash 2.05b, 3.0, 3.2, 3.2.48, and 4.0 enables the --show-control-chars option in LS_OPTIONS, which allows local users to send escape sequences to terminal emulators, or hide the existence of a file, via a crafted filename."
                        }
                    ],
                    "providerMetadata": {
                        "orgId": "79363d38-fa19-49d1-9214-5f28da3f3ac5"
                    },
                    "references": [
                        {
                            "url": "https://security-tracker.debian.org/tracker/CVE-2010-0002"
                        }
                    ]
                }
            ],
            "cna": {
                "affected": [
                    {
                        "cpes": [
                            "cpe:2.3:a:gnu:bash:2.05:b:*:*:*:*:*:*"
                        ],
                        "defaultStatus": "unaffected",
                        "product": "bash b",
                        "vendor": "gnu",
                        "versions": [
                            {
                                "status": "affected",
                                "version": "2.05"
                            }
                        ]
                    }
                ],
                "descriptions": [
                    {
                        "lang": "en",
                        "value": "The /etc/profile.d/60alias.sh script in the Mandriva bash package for Bash 2.05b, 3.0, 3.2, 3.2.48, and 4.0 enables the --show-control-chars option in LS_OPTIONS, which allows local users to send escape sequences to terminal emulators, or hide the existence of a file, via a crafted filename."
                    }
                ],
                "metrics": [
                    {
                        "cvssV2_0": {
                            "accessComplexity": "LOW",
                            "accessVector": "LOCAL",
                            "authentication": "NONE",
                            "availabilityImpact": "PARTIAL",
                            "baseScore": 2.1,
                            "confidentialityImpact": "NONE",
                            "integrityImpact": "NONE",
                            "vectorString": "AV:L/AC:L/Au:N/C:N/I:N/A:P",
                            "version": "2.0"
                        },
                        "format": "CVSS"
                    }
                ],
                "providerMetadata": {
                    "orgId": "00000000-0000-4000-A000-000000000000",
                    "shortName": "@redhat.com"
                },
                "references": [
                    {
                        "name": "https://qa.mandriva.com/show_bug.cgi?id=56882",
                        "url": "https://qa.mandriva.com/show_bug.cgi?id=56882"
                    }
                ]
            }
        },
        "cveMetadata": {
            "assignerOrgId": "00000000-0000-4000-A000-000000000000",
            "assignerShortName": "@redhat.com",
            "cveId": "CVE-2010-0002",
            "datePublished": "2010-01-14T18:30:00.000Z",
            "dateUpdated": "2011-08-08T04:00:00.000Z",
            "state": "PUBLISHED"
        },
        "dataType": "CVE_RECORD",
        "dataVersion": "5.0"
    }
)"};

auto constexpr INVALID_TYPE {R"(
    {
        "offset": 3,
        "type": "invalid",
        "version": 1,
        "context": "vulnerabilities",
        "resource": "CVE-2010-0002"
    }
)"};

/*
 * @brief Test a new resource.
 */
TEST_F(EventDecoderTest, TestCreatedResource)
{
    std::vector<char> message {};
    auto jsonResource = nlohmann::json::parse(CREATED_RESOURCE);
    auto eventContext = std::make_shared<EventContext>(
        EventContext {.message = message, .resource = jsonResource, .cvesDatabase = m_cvesDb});

    std::shared_ptr<EventDecoder> eventDecoder;

    // Instantiation of the EventDecoder class.
    EXPECT_NO_THROW(eventDecoder = std::make_shared<EventDecoder>());

    // HandleRequest
    EXPECT_NO_THROW(eventDecoder->handleRequest(eventContext));

    // Verify flatbuffer.
    rocksdb::PinnableSlice slice;
    EXPECT_TRUE(m_cvesDb->get(CVE_ID, slice));

    flatbuffers::Verifier verifierCVE5(reinterpret_cast<const uint8_t*>(slice.data()), slice.size());
    EXPECT_TRUE(cve_v5::VerifyEntryBuffer(verifierCVE5));

    // Verify data
    flatbuffers::IDLOptions options;
    options.strict_json = true;

    flatbuffers::Parser parser(options);
    EXPECT_TRUE(parser.Parse(cve5_SCHEMA));

    std::string jsongen;
    flatbuffers::GenText(parser, reinterpret_cast<const uint8_t*>(slice.data()), &jsongen);
    EXPECT_EQ(nlohmann::json::parse(jsongen), jsonResource.at("payload"));
}

/*
 * @brief Test an update for a resource.
 */
TEST_F(EventDecoderTest, TestUpdatedResource)
{
    std::vector<char> message {};
    auto jsonResource = nlohmann::json::parse(CREATED_RESOURCE);
    auto eventContext = std::make_shared<EventContext>(
        EventContext {.message = message, .resource = jsonResource, .cvesDatabase = m_cvesDb});

    std::shared_ptr<EventDecoder> eventDecoder;

    // Instantiation of the EventDecoder class.
    EXPECT_NO_THROW(eventDecoder = std::make_shared<EventDecoder>());

    // HandleRequest
    EXPECT_NO_THROW(eventDecoder->handleRequest(eventContext));

    // Apply update
    auto updatedJsonResource = nlohmann::json::parse(UPDATED_RESOURCE);
    auto updatedEventContext = std::make_shared<EventContext>(
        EventContext {.message = message, .resource = updatedJsonResource, .cvesDatabase = m_cvesDb});
    EXPECT_NO_THROW(eventDecoder->handleRequest(updatedEventContext));

    // Verify flatbuffer.
    rocksdb::PinnableSlice slice;
    EXPECT_TRUE(m_cvesDb->get(CVE_ID, slice));

    flatbuffers::Verifier verifierCVE5(reinterpret_cast<const uint8_t*>(slice.data()), slice.size());
    EXPECT_TRUE(cve_v5::VerifyEntryBuffer(verifierCVE5));

    // Verify data
    flatbuffers::IDLOptions options;
    options.strict_json = true;

    flatbuffers::Parser parser(options);
    EXPECT_TRUE(parser.Parse(cve5_SCHEMA));

    std::string jsongen;
    flatbuffers::GenText(parser, reinterpret_cast<const uint8_t*>(slice.data()), &jsongen);
    EXPECT_EQ(nlohmann::json::parse(jsongen), nlohmann::json::parse(UPDATED_DATA));
}

/*
 * @brief Test an invalid operation.
 */
TEST_F(EventDecoderTest, TestInvalidOperation)
{
    std::vector<char> message {};
    auto jsonResource = nlohmann::json::parse(INVALID_TYPE);
    auto eventContext = std::make_shared<EventContext>(
        EventContext {.message = message, .resource = jsonResource, .cvesDatabase = m_cvesDb});

    std::shared_ptr<EventDecoder> eventDecoder;

    // Instantiation of the EventDecoder class.
    EXPECT_NO_THROW(eventDecoder = std::make_shared<EventDecoder>());

    // HandleRequest
    EXPECT_THROW(eventDecoder->handleRequest(eventContext), std::runtime_error);
}
