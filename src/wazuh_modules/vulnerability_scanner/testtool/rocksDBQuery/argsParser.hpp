/*
 * Wazuh cmdLineParser
 * Copyright (C) 2015, Wazuh Inc.
 * Nov 13, 2023.
 *
 * This program is free software; you can redistribute it
 * and/or modify it under the terms of the GNU General Public
 * License (version 2) as published by the FSF - Free Software
 * Foundation.
 */

#ifndef _CMD_ARGS_PARSER_HPP_
#define _CMD_ARGS_PARSER_HPP_

#include "json.hpp"
#include <fstream>
#include <iostream>
#include <string>
#include <vector>

/**
 * @brief Class to parse command line arguments.
 */
class CmdLineArgs
{
public:
    /**
     * @brief Constructor for CmdLineArgs.
     * @param argc Number of arguments.
     * @param argv Arguments.
     */
    explicit CmdLineArgs(const int argc, const char* argv[])
        : m_dbPath {paramValueOf(argc, argv, "-d")}
        , m_fbsPath {paramValueOf(argc, argv, "-f", std::make_pair(false, ""))}
        , m_key {paramValueOf(argc, argv, "-k", std::make_pair(false, ""))}
        , m_columnFamilies {parseColumnFamilies(paramValueOf(argc, argv, "-c", std::make_pair(false, "")))}
        , m_columnQuery {paramValueOf(argc, argv, "-q", std::make_pair(false, "default"))}
    {
    }

    /**
     * @brief Get the DB path.
     *
     * @return std::string DB path.
     */
    std::string getDBPath()
    {
        return m_dbPath;
    }

    /**
     * @brief Get the .fbs schema path.
     *
     * @return std::string Schema path.
     */
    std::string getFbsPath()
    {
        return m_fbsPath;
    }

    /**
     * @brief Get the requested key.
     *
     * @return std::string Key.
     */
    std::string getKey()
    {
        return m_key;
    }

    /**
     * @brief Get the requested column families.
     *
     * @return std::vector<std::string> Column families.
     */
    std::vector<std::string> getColumnFamilies()
    {
        return m_columnFamilies;
    }

    /**
     * @brief Get the requested column query.
     *
     * @return std::string Column query.
     */
    std::string getColumnQuery()
    {
        return m_columnQuery;
    }

    /**
     * @brief Shows the help to the user.
     */
    static void showHelp()
    {
        std::cout << "\nUsage: rocksDBQuery <option(s)>\n"
                  << "Options:\n"
                  << "\t-h \t\t\tShow this help message\n"
                  << "\t-d <path> \t\tPath to the rocksDB database\n"
                  << "\t-f <path> \t\tPath to the .fbs schema file\n"
                  << "\t-c <columnFamilies> \tComma separated list of column families of the DB\n"
                  << "\t-k <key> \t\tKey to query\n"
                  << "\t-q <columnQuery> \tColumn query to filter the results\n"
                  << "\nExample:"
                  << "\n\t./rocksDBQuery -d rocksDBPath/ -f schema.fbs \n"
                  << "\n\t./rocksDBQuery -d rocksDBPath/ -f schema.fbs -c cf1,cf2 \n"
                  << "\n\t./rocksDBQuery -d rocksDBPath/ -f schema.fbs -c cf1,cf2 -q cf1\n"
                  << "\n\t./rocksDBQuery -d rocksDBPath/ -f schema.fbs -k key1 \n"
                  << "\n\t./rocksDBQuery -d rocksDBPath/ -q default \n"
                  << std::endl;
    }

private:
    static std::string paramValueOf(const int argc,
                                    const char* argv[],
                                    const std::string& switchValue,
                                    const std::pair<bool, std::string>& required = std::make_pair(true, ""))
    {
        for (int i = 1; i < argc; ++i)
        {
            const std::string currentValue {argv[i]};

            if (currentValue == switchValue && i + 1 < argc)
            {
                // Switch found
                return argv[i + 1];
            }
        }

        if (required.first)
        {
            throw std::runtime_error {"Switch value: " + switchValue + " not found."};
        }

        return required.second;
    }

    std::vector<std::string> parseColumnFamilies(const std::string& columnFamilies)
    {
        std::vector<std::string> result;

        if (columnFamilies.empty())
        {
            return result;
        }

        std::stringstream ss {columnFamilies};
        std::string token;

        while (std::getline(ss, token, ','))
        {
            result.push_back(token);
        }

        return result;
    }

    const std::string m_dbPath;
    const std::string m_fbsPath;
    const std::string m_key;
    const std::vector<std::string> m_columnFamilies;
    const std::string m_columnQuery;
};

#endif // _CMD_ARGS_PARSER_HPP_
